services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      APP_ENV: local
      APP_KEY: base64:85Z5V6gyulGadzq9P+zqSNw9svKSZOc5rg1zBKBUncM=
      APP_DEBUG: "true"
      APP_URL: http://localhost:8383
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 54322
      DB_DATABASE: laravel
      DB_USERNAME: laravel
      DB_PASSWORD: laravel
      BROADCAST_DRIVER: pusher
      BROADCAST_CONNECTION: pusher
      QUEUE_CONNECTION: sync
      CACHE_STORE: file
      SESSION_DRIVER: file
      PUSHER_APP_ID: app-id
      PUSHER_APP_KEY: app-key
      PUSHER_APP_SECRET: app-secret
      PUSHER_APP_CLUSTER: mt1
      PUSHER_HOST: soketi
      PUSHER_PORT: 6001
      PUSHER_SCHEME: http
      PUSHER_PUBLIC_HOST: localhost
      PUSHER_PUBLIC_PORT: 6001
      PUSHER_PUBLIC_SCHEME: http
      L5_SWAGGER_GENERATE_ALWAYS: "false"
      L5_FORMAT_TO_USE_FOR_DOCS: json
    depends_on:
      postgres:
        condition: service_healthy
      soketi:
        condition: service_started

  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    ports:
      - "8383:80"
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./public:/var/www/public:ro
    depends_on:
      - app

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    command: ["postgres", "-p", "54322"]
    environment:
      POSTGRES_DB: laravel
      POSTGRES_USER: laravel
      POSTGRES_PASSWORD: laravel
    ports:
      - "54322:54322"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U laravel -d laravel -p 54322"]
      interval: 5s
      timeout: 5s
      retries: 10

  soketi:
    image: quay.io/soketi/soketi:1.6-16-alpine
    restart: unless-stopped
    environment:
      SOKETI_DEFAULT_APP_ID: app-id
      SOKETI_DEFAULT_APP_KEY: app-key
      SOKETI_DEFAULT_APP_SECRET: app-secret
    ports:
      - "6001:6001"

volumes:
  postgres_data:
